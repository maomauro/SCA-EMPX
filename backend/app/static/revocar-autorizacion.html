<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revocar autorización - SCA-EMPX</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    label { display: block; margin-top: 0.5rem; }
    input, select, button { margin: 0.25rem 0.25rem 0.25rem 0; padding: 0.35rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #f0f0f0; }
    .msg { margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; }
    .ok { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Revocar autorización (HU-13)</h1>
  <p>Listado de autorizaciones vigentes. Solo se puede revocar una autorización en estado vigente.</p>

  <div>
    <label>Ver</label>
    <select id="estado">
      <option value="vigente" selected>Solo vigentes</option>
      <option value="">Todas</option>
      <option value="revocada">Revocadas</option>
      <option value="vencida">Vencidas</option>
      <option value="cancelada">Canceladas</option>
    </select>
    <button type="button" id="btnBuscar">Actualizar</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Persona</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
  <div id="msg" class="msg" style="display:none;"></div>

  <script>
    function params() {
      const estado = document.getElementById("estado").value;
      let url = "/api/v1/autorizaciones";
      if (estado) url += "?estado=" + encodeURIComponent(estado);
      return url;
    }

    function formatFecha(d) {
      if (!d) return "";
      const x = new Date(d);
      return isNaN(x.getTime()) ? d : x.toLocaleString("es-AR", { dateStyle: "short", timeStyle: "short" });
    }

    function mostrarMsg(texto, esOk) {
      const msg = document.getElementById("msg");
      msg.textContent = texto;
      msg.className = "msg " + (esOk ? "ok" : "error");
      msg.style.display = "block";
    }

    async function cargar() {
      try {
        const r = await fetch(params());
        const list = await r.json().catch(function() { return []; });
        const tbody = document.getElementById("tabla");
        tbody.innerHTML = "";
        (Array.isArray(list) ? list : []).forEach(function(a) {
          const tr = document.createElement("tr");
          const puedeRevocar = a.estado === "vigente";
          const btn = puedeRevocar
            ? "<button type=\"button\" data-id=\"" + a.id_autorizacion + "\">Revocar</button>"
            : "";
          tr.innerHTML =
            "<td>" + a.id_autorizacion + "</td>" +
            "<td>" + (a.nombre_completo || "ID " + a.id_persona) + "</td>" +
            "<td>" + formatFecha(a.fecha_inicio) + "</td>" +
            "<td>" + formatFecha(a.fecha_fin) + "</td>" +
            "<td>" + (a.estado || "") + "</td>" +
            "<td>" + btn + "</td>";
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll("button[data-id]").forEach(function(btn) {
          btn.onclick = function() { revocar(parseInt(btn.getAttribute("data-id"), 10)); };
        });
        document.getElementById("msg").style.display = "none";
      } catch (e) {
        mostrarMsg("Error: " + e.message, false);
      }
    }

    async function revocar(id) {
      const motivo = window.prompt("Motivo de revocación (opcional):", "");
      const body = { estado: "revocada" };
      if (motivo !== null && (motivo || "").trim()) body.motivo = motivo.trim();
      try {
        const r = await fetch("/api/v1/autorizaciones/" + id, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await r.json().catch(function() { return {}; });
        if (r.ok) {
          mostrarMsg("Autorización revocada correctamente.", true);
          cargar();
        } else {
          mostrarMsg(data.detail || "Error " + r.status, false);
        }
      } catch (e) {
        mostrarMsg("Error: " + e.message, false);
      }
    }

    document.getElementById("btnBuscar").onclick = cargar;
    cargar();
  </script>
</body>
</html>
